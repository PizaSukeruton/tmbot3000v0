<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TmBot3000</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0b0b; --panel:#121212; --text:#f5f5f5; --muted:#bdbdbd; --green:#00c853; --blue:#2196f3; --amber:#fbc02d; --red:#d32f2f; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:860px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column}
    header{padding:16px 20px;background:var(--panel);border-bottom:1px solid #1f1f1f;position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    #chat{flex:1;padding:16px 20px;display:flex;flex-direction:column;gap:10px}
    .msg{max-width:88%}
    .from-user{align-self:flex-end}
    .bubble{padding:10px 12px;border-radius:12px}
    .user-bubble{background:#1e1e1e;border:1px solid #2a2a2a}
    .bot-bubble{background:#151515;border:1px solid #222}
    .answer-box{background:#0f2217;border-left:4px solid var(--green);padding:10px;border-radius:10px}
    .schedule-box{background:#0e1a26;border-left:4px solid var(--blue);padding:10px;border-radius:10px}
    .help-box{background:#211f10;border-left:4px solid var(--amber);padding:10px;border-radius:10px}
    .error-box{background:#261112;border-left:4px solid var(--red);padding:10px;border-radius:10px}
    .meta{color:var(--muted);font-size:12px;margin-bottom:4px}
    ul.clean{margin:8px 0 0 18px}
    table.shows{width:100%;border-collapse:collapse;margin-top:6px}
    table.shows td{padding:6px 8px;border-bottom:1px solid #1f1f1f;vertical-align:top}
    table.shows tr:last-child td{border-bottom:0}
    form{display:flex;gap:8px;padding:12px 20px;background:var(--panel);border-top:1px solid #1f1f1f;position:sticky;bottom:0}
    input,button{font:inherit}
    input[type="text"]{flex:1;background:#151515;border:1px solid #262626;color:var(--text);padding:10px;border-radius:10px}
    input[type="text"]::placeholder{color:#7c7c7c}
    input[type="text"]:focus{outline:none;border-color:#3a3a3a}
    .row{display:flex;gap:8px}
    .small{width:190px}
    button{background:#ffffff10;border:1px solid #2a2a2a;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    button:hover{background:#ffffff14}
    .tiny{font-size:12px;color:#9a9a9a;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>TmBot3000</h1>
    </header>

    <main id="chat" aria-live="polite"></main>

    <form id="chat-form">
      <div class="row" style="flex:1">
        <input id="message" type="text" placeholder="Type a messageâ€¦ e.g., what is FOH?  |  what shows do we have coming up?" autocomplete="off" />
        <input id="memberId" class="small" type="text" value="#700001" autocomplete="off" />
      </div>
      <button type="submit">Send</button>
    </form>

    <div class="tiny" style="padding:0 20px 16px 20px">Another Fine Product From We Make Troubleâ„¢ / Chaos Division</div>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('message');
    const memberIdEl = document.getElementById('memberId');

    function addUserMessage(text){
      const wrap=document.createElement('div');
      wrap.className='msg from-user';
      wrap.innerHTML = '<div class="meta">You</div><div class="bubble user-bubble"></div>';
      wrap.querySelector('.bubble').textContent=text;
      chat.appendChild(wrap);
      chat.scrollTop=chat.scrollHeight;
    }

    function addBotBlock(node,label){
      const wrap=document.createElement('div');
      wrap.className='msg';
      wrap.innerHTML = '<div class="meta">'+label+'</div>';
      const bubble=document.createElement('div');
      bubble.className='bubble bot-bubble';
      bubble.appendChild(node);
      wrap.appendChild(bubble);
      chat.appendChild(wrap);
      chat.scrollTop=chat.scrollHeight;
    }

    function textBlock(html){
      const d=document.createElement('div');
      d.innerHTML=html;
      return d;
    }

    function renderScheduleTextToTable(text){
      const lines=text.split('\n').map(l=>l.trim()).filter(Boolean);
      const rows=[];
      for(const l of lines){
        rows.push(l);
      }
      const table=document.createElement('table');
      table.className='shows';
      let cur=[];
      function flush(){
        if(cur.length){
          const tr=document.createElement('tr');
          const td=document.createElement('td');
          td.innerHTML=cur.join('<br>');
          tr.appendChild(td);
          table.appendChild(tr);
          cur=[];
        }
      }
      for(const line of rows){
      }
      for(const line of rows){
        if (/^\d+\.\s/.test(line)){ flush(); cur.push(line.replace(/^\d+\.\s*/,'')); continue; }
        if (/^(ðŸ“|ðŸšª|ðŸŽ«|ðŸŽŸï¸)/.test(line)){ cur.push(line); continue; }
        if (/^(I found \d+ show|I found \d+ shows)/i.test(line)){ continue; }
        if (line==='') { flush(); continue; }
        if (/^[A-Za-z]+day\b/.test(line)){ flush(); cur.push(line); continue; }
        cur.push(line);
      }
      flush();
      return table;
    }

    function renderResponse(aiResponse){
      let type = aiResponse && aiResponse.type ? aiResponse.type : 'answer';
      if (type === "fallback") type = "error";
      const text = aiResponse && aiResponse.text ? aiResponse.text : '';

      switch(type){
        case 'answer': {
          const box=document.createElement('div');
          box.className='answer-box';
          box.innerHTML='âœ… ' + (text || 'Done');
          addBotBlock(box,'Answer');
          break;
        }
        case 'schedule': {
          const box=document.createElement('div');
          box.className='schedule-box';
          const header=document.createElement('div');
          header.textContent='Schedule';
          const table=renderScheduleTextToTable(text);
          box.appendChild(table);
          addBotBlock(box,'Schedule');
          break;
        }
        case 'help': {
          const box=document.createElement('div');
          box.className='help-box';
          box.innerHTML='ðŸ’¡ ' + (text || 'You can ask me about shows, schedules, venues, or tour details.');
          addBotBlock(box,'Help');
          break;
        }
        case 'fallback': {
          const box=document.createElement('div');
          box.className='error-box';
          box.innerHTML='âŒ ' + (text || 'Sorry, I didnâ€™t understand that.');
          addBotBlock(box,'Notice');
          break;
        }
        case 'unknown':
        case 'error':
        default: {
          const box=document.createElement('div');
          box.className='error-box';
          box.innerHTML='âŒ ' + (text || 'Sorry, I didnâ€™t understand that.');
          addBotBlock(box,'Notice');
          break;
        }
      }
    }

    async function sendMessage(q){
      const memberId = memberIdEl.value || '#700001';
      const res = await fetch('/api/chat/message', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ memberId, content: q })
      });
      if(!res.ok){
        renderResponse({ type:'error', text:'HTTP ' + res.status + ' from /api/chat/message' });
        return;
      }
      const data = await res.json();
      if (data && data.aiResponse){
        renderResponse(data.aiResponse);
      } else {
        renderResponse({ type:'error', text:'Malformed response' });
      }
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const q=input.value.trim();
      if(!q) return;
      addUserMessage(q);
      input.value='';
      try{
        await sendMessage(q);
      }catch(err){
        renderResponse({ type:'error', text:String(err) });
      }
    });

    function quickTest(msg){ addUserMessage(msg); sendMessage(msg); }

    window.tmbot = {
      testAnswer: ()=>quickTest('what is FOH?'),
      testSchedule: ()=>quickTest('what shows do we have coming up?'),
      testNext: ()=>quickTest('next show'),
      testError: ()=>quickTest('gibberish words')
    };
  </script>
</body>
</html>
